<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blockly Demo:</title>
  <link rel="stylesheet" href="style.css">
  <script src="../../blockly_compressed.js"></script>
  <script src="../../blocks_compressed.js"></script>
  <script src="../../javascript_compressed.js"></script>
  <script src="../../php_compressed.js"></script>
  <script src="codePvMonit.js"></script>
</head>
<body>
  <table width="100%" height="100%">
    <tr>
      <td>
        <h1>
            Code change
        </h1>
            
            <a onclick="generate()">Generate PHP &#10548;</a>
          
      </td>
      <td class="farSide">
        <select id="languageMenu"></select>
      </td>
    </tr>
    <tr>
      <td colspan=2>
        <table width="100%">
          <tr id="tabRow" height="1em">
            <td id="tab_blocks" class="tabon">...</td>
            <td class="tabmin tab_collapse">&nbsp;</td>
            <td id="tab_javascript" class="taboff tab_collapse">JavaScript</td>
            <td class="tabmin tab_collapse">&nbsp;</td>
            <td id="tab_php" class="taboff tab_collapse">PHP</td>
            <td class="tabmin tab_collapse">&nbsp;</td>
            <td id="tab_xml" class="taboff tab_collapse">XML</td>
            <td class="tabmin">&nbsp;</td>
            <td id="tab_code" class="taboff">
              <select id="code_menu"></select>
            </td>
            <td class="tabmax">
              <button id="trashButton" class="notext" title="...">
                <img src='../../media/1x1.gif' class="trash icon21">
              </button>
              <button id="linkButton" class="notext" title="...">
                <img src='../../media/1x1.gif' class="link icon21">
              </button>
              <button id="runButton" class="notext primary" title="...">
                <img src='../../media/1x1.gif' class="run icon21">
              </button>
            </td>
          </tr>
        </table>
      </td>
    </tr>
    <tr>
      <td height="99%" colspan=2 id="content_area">
      </td>
    </tr>
  </table>
  <div id="content_blocks" class="content"></div>
  <pre id="content_javascript" class="content prettyprint lang-js"></pre>
  <pre id="content_php" class="content prettyprint lang-php"></pre>
  <textarea id="content_xml" class="content" wrap="off"></textarea>


  <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">
    <category name="PvMonit" colour='60'>
        <block type="variables_get">
          <field name="VAR" id="GV6h1rQ^p9]JM0qQb5eW">retour_log</field>
        </block>
        <block type="variables_get">
          <field name="VAR" id="0qQb5eGV3j7rv^pE]J3W">retour_mod</field>
        </block>
        <block type="data_SOC"></block>
        <block type="data_CS"></block>
        <block type="date_j"></block>
        <block type="math_change"></block>
        <block type="timeupmin"></block>
    </category>
    <category name="Date" colour='0'>
        <block type="date_now"></block>
        <block type="time_now"></block>
    </category>
    <category name="%{BKY_CATLOGIC}" colour="%{BKY_LOGIC_HUE}">
      <block type="controls_if"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_boolean"></block>
      <block type="logic_null"></block>
      <block type="logic_ternary"></block>
    </category>
    <category name="%{BKY_CATLOOPS}" colour="%{BKY_LOOPS_HUE}">
      <block type="controls_repeat_ext">
        <value name="TIMES">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
      </block>
      <block type="controls_whileUntil"></block>
      <block type="controls_for">
        <value name="FROM">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="TO">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
        <value name="BY">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
      </block>
      <block type="controls_forEach"></block>
      <block type="controls_flow_statements"></block>
    </category>
    <category name="%{BKY_CATMATH}" colour="%{BKY_MATH_HUE}">
      <block type="math_number">
        <field name="NUM">123</field>
      </block>
      <block type="math_arithmetic">
        <value name="A">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="B">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
      </block>
      <block type="math_single">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">9</field>
          </shadow>
        </value>
      </block>
      <block type="math_trig">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">45</field>
          </shadow>
        </value>
      </block>
      <block type="math_constant"></block>
      <block type="math_number_property">
        <value name="NUMBER_TO_CHECK">
          <shadow type="math_number">
            <field name="NUM">0</field>
          </shadow>
        </value>
      </block>
      <block type="math_round">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">3.1</field>
          </shadow>
        </value>
      </block>
      <block type="math_on_list"></block>
      <block type="math_modulo">
        <value name="DIVIDEND">
          <shadow type="math_number">
            <field name="NUM">64</field>
          </shadow>
        </value>
        <value name="DIVISOR">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
      </block>
      <block type="math_constrain">
        <value name="VALUE">
          <shadow type="math_number">
            <field name="NUM">50</field>
          </shadow>
        </value>
        <value name="LOW">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="HIGH">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
      </block>
      <block type="math_random_int">
        <value name="FROM">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="TO">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
      </block>
      <block type="math_random_float"></block>
      <block type="math_atan2">
        <value name="X">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="Y">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
      </block>
    </category>
    <category name="%{BKY_CATTEXT}" colour="%{BKY_TEXTS_HUE}">
      <block type="text"></block>
      <block type="text_join"></block>
      <block type="text_append">
        <value name="TEXT">
          <shadow type="text"></shadow>
        </value>
      </block>
      <block type="text_length">
        <value name="VALUE">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_isEmpty">
        <value name="VALUE">
          <shadow type="text">
            <field name="TEXT"></field>
          </shadow>
        </value>
      </block>
      <block type="text_indexOf">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">{textVariable}</field>
          </block>
        </value>
        <value name="FIND">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_charAt">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">{textVariable}</field>
          </block>
        </value>
      </block>
      <block type="text_getSubstring">
        <value name="STRING">
          <block type="variables_get">
            <field name="VAR">{textVariable}</field>
          </block>
        </value>
      </block>
      <block type="text_changeCase">
        <value name="TEXT">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_trim">
        <value name="TEXT">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_print">
        <value name="TEXT">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_prompt_ext">
        <value name="TEXT">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
    </category>
    <category name="%{BKY_CATLISTS}" colour="%{BKY_LISTS_HUE}">
      <block type="lists_create_with">
        <mutation items="0"></mutation>
      </block>
      <block type="lists_create_with"></block>
      <block type="lists_repeat">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">5</field>
          </shadow>
        </value>
      </block>
      <block type="lists_length"></block>
      <block type="lists_isEmpty"></block>
      <block type="lists_indexOf">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">{listVariable}</field>
          </block>
        </value>
      </block>
      <block type="lists_getIndex">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">{listVariable}</field>
          </block>
        </value>
      </block>
      <block type="lists_setIndex">
        <value name="LIST">
          <block type="variables_get">
            <field name="VAR">{listVariable}</field>
          </block>
        </value>
      </block>
      <block type="lists_getSublist">
        <value name="LIST">
          <block type="variables_get">
            <field name="VAR">{listVariable}</field>
          </block>
        </value>
      </block>
      <block type="lists_split">
        <value name="DELIM">
          <shadow type="text">
            <field name="TEXT">,</field>
          </shadow>
        </value>
      </block>
      <block type="lists_sort"></block>
      <variables>
        <variable id="*-Bj~QnqL*}/Qw.hseT*">data_pv</variable>
      </variables>
      <block type="variables_get" id="WEAN]pJkkp~@-$data_pv*" x="8" y="142">
        <field name="VAR" id="*-Bj~QnqL*}/Qw.hseT*">data_pv</field>
      </block>
    </category>
    <sep></sep>
    <category name="%{BKY_CATVARIABLES}" colour="%{BKY_VARIABLES_HUE}" custom="VARIABLE"></category>
    <category name="%{BKY_CATFUNCTIONS}" colour="%{BKY_PROCEDURES_HUE}" custom="PROCEDURE"></category>
  </xml>
<script type="text/javascript">
function generate() {
    // Generer le code XML
    var xmlDom = Blockly.Xml.workspaceToDom(Code.workspace);
    var xmlText = Blockly.Xml.domToPrettyText(xmlDom);
  alert(xmlText);
  
  try {
    var xml = Blockly.Xml.textToDom(xmlText)
  } catch (e) {
    alert(e);
    return;
  }
  // Create a headless workspace.
  var demoWorkspace = new Blockly.Workspace();
  Blockly.Xml.domToWorkspace(xml, demoWorkspace);
  var code = Blockly.PHP.workspaceToCode(demoWorkspace);
  alert(code);
}

var date_now_json = {
  "type": "date_now",
  "lastDummyAlign0": "RIGHT",
  "message0": "Date actuelle %1",
  "args0": [
    {
      "type": "field_dropdown",
      "name": "format",
      "options": [
        [
          "Jour du mois (1 à 31)",
          "j"
        ],
        [
          "Jour de la semaine (1 (pour Lundi) à 7 (pour Dimanche)",
          "n"
        ],
        [
          "Jour de l'année (Jour de l'année 0 à 365)",
          "z"
        ],
        [
          "Mois (1 à 12)",
          "n"
        ],
        [
          "Année sur 4 chiffres (1999 ou 2003...)",
          "Y"
        ]
      ]
    }
  ],
  "output": "Number",
  "colour": 0,
  "tooltip": "La date du moment sous différent format",
  "helpUrl": "https://www.php.net/manual/fr/function.date.php"
};
Blockly.Blocks['date_now'] = {
  init: function() {
    this.jsonInit(date_now_json);
    // Assign 'this' to a variable for use in the tooltip closure below.
  }
};
Blockly.JavaScript['date_now'] = function(block) {
  var dropdown_format = block.getFieldValue('format');
  // TODO: Assemble JavaScript into code variable.
  var code = '...';
  // TODO: Change ORDER_NONE to the correct strength.
  return [code, Blockly.JavaScript.ORDER_NONE];
};
Blockly.PHP['date_now'] = function(block) {
    var dropdown_format = block.getFieldValue('format');
    // TODO: Assemble JavaScript into code variable.
    var code = 'date("%'+dropdown_format+'")';
    // TODO: Change ORDER_NONE to the correct strength.
    return [code, Blockly.JavaScript.ORDER_NONE];
};

Blockly.Blocks['time_now'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("Heure actuelle")
        .appendField(new Blockly.FieldDropdown([["Heure, au format 12h (1 à 12)","g"], ["Heure, au format 24h (1 à 23)","G"], ["Minutes (00 à 59)","i"], ["Secondes depuis l'époque Unix (1er Janvier 1970)","U"]]), "format");
    this.setOutput(true, "Number");
    this.setColour(0);
 this.setTooltip("L'heure du moment sous différent format");
 this.setHelpUrl("https://www.php.net/manual/fr/function.date.php");
  }
};
Blockly.JavaScript['time_now'] = function(block) {
  var dropdown_format = block.getFieldValue('format');
  // TODO: Assemble JavaScript into code variable.
  var code = '...';
  // TODO: Change ORDER_NONE to the correct strength.
  return [code, Blockly.JavaScript.ORDER_NONE];
};
Blockly.PHP['time_now'] = function(block) {
  var dropdown_format = block.getFieldValue('format');
  // TODO: Assemble PHP into code variable.
  var code = 'date("%'+dropdown_format+'")';
  // TODO: Change ORDER_NONE to the correct strength.
  return [code, Blockly.PHP.ORDER_NONE];
};



Blockly.Blocks['timeupmin'] = {
  init: function() {
    this.appendValueInput("id")
        .setCheck("Number")
        .appendField("timeUpMin")
        .appendField(" id");
    this.appendDummyInput()
        .appendField(new Blockly.FieldNumber(200, 0, 86400, 1), "delai")
        .appendField("s");
    this.appendDummyInput()
        .appendField("| Pour la simulation ")
        .appendField(new Blockly.FieldDropdown([["true","true"], ["false","false"]]), "simu_return");
    this.setInputsInline(true);
    this.setOutput(true, "Boolean");
    this.setColour(60);
 this.setTooltip("retourne true si le temps minimum (en seconde) n'est pas encore écoulé depuis l'allumage");
 this.setHelpUrl("https://framagit.org/kepon/PvMonit/-/blob/master/domo/relay.script.d/ID.php.exemple#L32");
  }
};
Blockly.PHP['timeupmin'] = function(block) {
  var value_id = Blockly.PHP.valueToCode(block, 'id', Blockly.PHP.ORDER_ATOMIC);
  var number_delai = block.getFieldValue('delai');
  // TODO: Assemble PHP into code variable.
  var code = 'timeUpMin('+value_id+', '+number_delai+')';
  // TODO: Change ORDER_NONE to the correct strength.
  return [code, Blockly.PHP.ORDER_NONE];
};
Blockly.JavaScript['timeupmin'] = function(block) {
  var dropdown_simu_return = block.getFieldValue('simu_return');
  // TODO: Assemble JavaScript into code variable.
  var code = dropdown_simu_return;
  // TODO: Change ORDER_NONE to the correct strength.
  return [code, Blockly.JavaScript.ORDER_NONE];
};

var date_j_Json = {
  "type": "date_j",
  "message0": "Date %1",
  "args0": [
    {
      "type": "input_value",
      "name": "NAME",
      "check": "String"
    }
  ],
  "inputsInline": true,
  "output": "Number",
  "colour": 60,
  "tooltip": "too",
  "helpUrl": "http://www.unicode.org/reports/tr35/tr35-dates.html#Date_Field_Symbol_Table"
};
Blockly.Blocks['date_j'] = {
  init: function() {
    this.jsonInit(date_j_Json);
    // Assign 'this' to a variable for use in the tooltip closure below.
  }
};
Blockly.PHP['date_j'] = function(block) {
  // TODO: Assemble JavaScript into code variable.
  var code = 'date("%d")';
  // TODO: Change ORDER_NONE to the correct strength.
  return [code, Blockly.JavaScript.ORDER_NONE];
};
Blockly.JavaScript['date_j'] = function(block) {
  var value_name = Blockly.JavaScript.valueToCode(block, 'NAME', Blockly.JavaScript.ORDER_ATOMIC);
  // TODO: Assemble JavaScript into code variable.
  var code = 'new Date().getDay()';
  //~ var code = 'New date().format(\'Y/m/d H:i:s\');';
  
  // TODO: Change ORDER_NONE to the correct strength.
  return [code, Blockly.JavaScript.ORDER_NONE];
};



var data_SOC_json = {
  "type": "data_SOC",
  "message0": "data SOC | Pour la simulation %1",
  "args0": [
    {
      "type": "field_number",
      "name": "simu_return",
      "value": 90,
      "min": 0,
      "max": 100,
      "precision": 1
    }
  ],
  "output": [
    "Number"
  ],
  "colour": 60,
  "tooltip": "Données configuré dans le config.yaml (domo / valueUse)",
  "helpUrl": "https://framagit.org/kepon/PvMonit/-/blob/master/domo/relay.script.d/ID.php.exemple#L19"
};
Blockly.Blocks['data_SOC'] = {
  init: function() {
    this.jsonInit(data_SOC_json);
  }
};
Blockly.PHP['data_SOC'] = function(block) {
  var code = '$data[\'SOC\']';
  return [code, Blockly.PHP.ORDER_NONE];
};
Blockly.JavaScript['data_SOC'] = function(block) {
  var number_simu_return = block.getFieldValue('simu_return');
  var code = number_simu_return;
  return [code, Blockly.JavaScript.ORDER_NONE];
};


var data_CS_json = {
  "type": "data_cs",
  "message0": "data CS | Pour la simulation %1",
  "args0": [
    {
      "type": "field_dropdown",
      "name": "simu_return",
      "options": [
        [
          "Float",
          "Float"
        ],
        [
          "Absorption",
          "Absorption"
        ],
        [
          "Bulk",
          "Bulk"
        ],
        [
          "Off",
          "Off"
        ],
        [
          "Fault",
          "Fault"
        ]
      ]
    }
  ],
  "output": "String",
  "colour": 60,
  "tooltip": "Etat régulateur",
  "helpUrl": ""
};
Blockly.Blocks['data_CS'] = {
  init: function() {
    this.jsonInit(data_CS_json);
  }
};
Blockly.PHP['data_CS'] = function(block) {
  var code = '$data[\'CS\']';
  return [code, Blockly.PHP.ORDER_NONE];
};
Blockly.JavaScript['data_CS'] = function(block) {
  var number_simu_return = block.getFieldValue('simu_return');
  var code = '\''+number_simu_return+'\'';
  return [code, Blockly.JavaScript.ORDER_NONE];
};


 var mathChangeJson = {
  "message0": "change %1 by %2",
  "args0": [
    {"type": "field_variable", "name": "VAR", "variable": "item", "variableTypes": [""]},
    {"type": "input_value", "name": "DELTA", "check": "Number"}
  ],
  "previousStatement": null,
  "nextStatement": null,
  "colour": 230
};
Blockly.Blocks['math_change'] = {
  init: function() {
    this.jsonInit(mathChangeJson);
    // Assign 'this' to a variable for use in the tooltip closure below.
  }
};

</script>
</body>
</html>
